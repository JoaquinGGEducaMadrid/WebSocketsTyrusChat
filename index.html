<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8">
<title>Chat WebSocket</title>
<style>
    body { font-family: Arial, sans-serif; max-width: 600px; margin: 20px auto; }
    #chat { border: 1px solid #ccc; height: 250px; overflow-y: auto; padding: 5px; margin-bottom: 10px; }
    #users { border: 1px solid #ccc; height: 100px; overflow-y: auto; padding: 5px; margin-bottom: 10px; }
</style>
</head>
<body>

<h2>Chat WebSocket</h2>

<label>Nick: <input id="nick" autocomplete="off"></label>
<button onclick="connect()">Conectar</button>

<h3>Usuarios conectados</h3>
<div id="users"></div>

<h3>Chat</h3>
<div id="chat"></div>

<input id="msg" placeholder="Escribe un mensaje" autocomplete="off">
<button onclick="sendMsg()">Enviar</button>

<script>
let ws;

function connect() {
    const nick = document.getElementById("nick").value.trim();
    if (!nick) {
        alert("Introduce un nick antes de conectar");
        return;
    }

    // Detectar si estamos en local o en Render
    let url;
    if (location.hostname === "localhost") {
        // WebSocket local (tu servidor WS escucha en 8080)
        url = "ws://localhost:8080/ws/chat";
    } else {
        // WebSocket en Render (mismo dominio, sin puerto)
        url = "wss://" + location.host + "/ws/chat";
    }

    ws = new WebSocket(url);

    ws.onopen = () => {
        ws.send(nick); // Primer mensaje = nick
    };

    ws.onmessage = (event) => {
        const data = JSON.parse(event.data);

        // Lista de usuarios
        if (data.type === "users") {
            document.getElementById("users").innerText = data.list;
            return;
        }

        // Mensaje normal
        const chat = document.getElementById("chat");
        chat.innerHTML += `<p><strong>${data.sender}:</strong> ${data.msg}</p>`;
        chat.scrollTop = chat.scrollHeight;
    };

    ws.onclose = () => {
        const chat = document.getElementById("chat");
        chat.innerHTML += `<p><em>Desconectado del servidor</em></p>`;
    };
}

function sendMsg() {
    const msg = document.getElementById("msg").value.trim();
    if (msg && ws && ws.readyState === WebSocket.OPEN) {
        ws.send(msg);
        document.getElementById("msg").value = "";
    }
}
</script>

</body>
</html>
